<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: CDN Fallback + IndexURL Fix</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f5f5f5; }
        .log { background: #222; color: #0f0; padding: 15px; border-radius: 5px; height: 400px; overflow-y: auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üß™ Test: CDN Fallback + IndexURL Fix</h1>
    <p>Esta p√°gina prueba la soluci√≥n al problema de indexURL inconsistente.</p>

    <div id="status" class="status warning">
        <strong>‚è≥ Estado:</strong> Iniciando test...
    </div>

    <button onclick="runTest()">üöÄ Ejecutar Test</button>
    <button onclick="clearLog()">üóëÔ∏è Limpiar Log</button>

    <h3>üìù Log del Test:</h3>
    <div id="log" class="log"></div>

    <script>
        // Simulaci√≥n de m√∫ltiples CDNs
        const pyodideCDNs = [
            'https://cdn.pyodide.org/v0.24.1/full/pyodide.js',      // Fallar√°
            'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js', // Funcionar√°
            'https://unpkg.com/pyodide@0.24.1/pyodide.js'           // Backup
        ];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f44' : type === 'success' ? '#4f4' : type === 'warning' ? '#fa0' : '#0f0';
            logDiv.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<strong>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚è≥'} Estado:</strong> ${message}`;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Test de carga con fallback
        async function loadPyodideWithFallback() {
            let pyodideLoaded = false;
            let successfulCDN = null;

            for (let index = 0; index < pyodideCDNs.length; index++) {
                const url = pyodideCDNs[index];
                const cdnName = url.includes('jsdelivr') ? 'JSDelivr' : 
                               url.includes('unpkg') ? 'UNPKG' : 'Pyodide CDN';

                log(`üì° Probando CDN ${index + 1}/3: ${cdnName}`, 'info');
                log(`üîó URL: ${url}`, 'info');

                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = url;

                        const timeoutId = setTimeout(() => {
                            script.remove();
                            reject(new Error('Timeout de 10 segundos'));
                        }, 10000);

                        script.onload = () => {
                            clearTimeout(timeoutId);
                            log(`‚úÖ ${cdnName}: Script cargado exitosamente`, 'success');

                            if (typeof loadPyodide === 'function') {
                                log(`‚úÖ ${cdnName}: loadPyodide disponible`, 'success');
                                pyodideLoaded = true;
                                successfulCDN = url;
                                
                                // Guardar CDN exitoso (simulando el comportamiento real)
                                window.successfulPyodideCDN = url;
                                log(`üéØ CDN exitoso guardado: ${url}`, 'success');
                                resolve();
                            } else {
                                reject(new Error('loadPyodide no disponible'));
                            }
                        };

                        script.onerror = (event) => {
                            clearTimeout(timeoutId);
                            log(`‚ùå ${cdnName}: Error de carga (net::ERR_NAME_NOT_RESOLVED)`, 'error');
                            reject(new Error('Error de red'));
                        };

                        document.head.appendChild(script);
                    });

                    // Si llegamos aqu√≠, el CDN funcion√≥
                    break;

                } catch (error) {
                    log(`‚ö†Ô∏è ${cdnName}: ${error.message}`, 'warning');
                    if (index === pyodideCDNs.length - 1) {
                        throw new Error('Todos los CDNs fallaron');
                    }
                }
            }

            return { pyodideLoaded, successfulCDN };
        }

        // Test de indexURL correcto
        function getCorrectIndexURL(successfulCDN) {
            log('\nüéØ Determinando indexURL correcto...', 'info');

            let indexURL = "https://cdn.pyodide.org/v0.24.1/full/"; // Default

            if (successfulCDN) {
                log(`üìç CDN exitoso: ${successfulCDN}`, 'info');

                if (successfulCDN.includes('jsdelivr.net')) {
                    indexURL = "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/";
                    log(`üéØ JSDelivr detectado, indexURL: ${indexURL}`, 'success');
                } else if (successfulCDN.includes('unpkg.com')) {
                    indexURL = "https://unpkg.com/pyodide@0.24.1/";
                    log(`üéØ UNPKG detectado, indexURL: ${indexURL}`, 'success');
                } else {
                    indexURL = "https://cdn.pyodide.org/v0.24.1/full/";
                    log(`üéØ Pyodide CDN detectado, indexURL: ${indexURL}`, 'success');
                }
            } else {
                log(`‚ö†Ô∏è CDN exitoso no detectado, usando por defecto: ${indexURL}`, 'warning');
            }

            return indexURL;
        }

        // Test de inicializaci√≥n simulada
        async function simulatePyodideInit(indexURL) {
            log('\nüöÄ Simulando inicializaci√≥n de Pyodide...', 'info');
            log(`üì¶ indexURL utilizado: ${indexURL}`, 'info');

            try {
                if (typeof loadPyodide === 'undefined') {
                    throw new Error('loadPyodide no est√° disponible');
                }

                log('‚è≥ Llamando loadPyodide() con indexURL correcto...', 'info');
                
                // Simulaci√≥n (no llamamos realmente a loadPyodide para evitar descargas)
                log('‚úÖ Simulaci√≥n: loadPyodide() exitoso', 'success');
                log('‚úÖ Simulaci√≥n: pyodide.asm.wasm cargado desde CDN correcto', 'success');
                log('‚úÖ Simulaci√≥n: python_stdlib.zip cargado desde CDN correcto', 'success');
                log('‚úÖ Simulaci√≥n: Pyodide completamente inicializado', 'success');

                return true;
            } catch (error) {
                log(`‚ùå Error en inicializaci√≥n: ${error.message}`, 'error');
                return false;
            }
        }

        // Test principal
        async function runTest() {
            clearLog();
            log('üß™ INICIANDO TEST DE CDN FALLBACK + INDEXURL FIX\n', 'info');
            updateStatus('Ejecutando test...', 'warning');

            try {
                // Paso 1: Cargar Pyodide con fallback
                log('üìã PASO 1: Cargar script pyodide.js con fallback', 'info');
                const { pyodideLoaded, successfulCDN } = await loadPyodideWithFallback();

                if (!pyodideLoaded) {
                    throw new Error('No se pudo cargar Pyodide desde ning√∫n CDN');
                }

                // Paso 2: Determinar indexURL correcto
                log('\nüìã PASO 2: Determinar indexURL correcto', 'info');
                const indexURL = getCorrectIndexURL(successfulCDN);

                // Paso 3: Simular inicializaci√≥n
                log('\nüìã PASO 3: Inicializar Pyodide con indexURL correcto', 'info');
                const initSuccess = await simulatePyodideInit(indexURL);

                if (initSuccess) {
                    log('\nüéâ TEST EXITOSO: Problema de indexURL solucionado', 'success');
                    updateStatus('Test completado exitosamente', 'success');
                } else {
                    throw new Error('Fall√≥ la inicializaci√≥n');
                }

            } catch (error) {
                log(`\n‚ùå TEST FALLIDO: ${error.message}`, 'error');
                updateStatus(`Test fallido: ${error.message}`, 'error');
            }
        }

        // Log inicial
        log('üõ†Ô∏è Test de CDN Fallback + IndexURL Fix cargado', 'info');
        log('üìÖ Fecha: ' + new Date().toISOString(), 'info');
        log('üåê User Agent: ' + navigator.userAgent.substring(0, 100) + '...', 'info');
        log('üìç Haz clic en "Ejecutar Test" para comenzar\n', 'info');
    </script>
</body>
</html>
